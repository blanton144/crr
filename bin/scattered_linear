#!/usr/bin/env python

import os
import matplotlib.pyplot as plt
import matplotlib.cm as cm
import matplotlib
import numpy as np
import crr.scattered.sampling as sampling

dpi = 120
matplotlib.rcParams['font.size'] = 30
matplotlib.rcParams['figure.figsize'] = [10.5, 8.4]

samples = sampling.Sampling(nsamples=1000)
samples.set_flux(total_flux=1000., noise=1.e-3)

# Fit linear model, no noise, no regularization
(U, S, VT) = np.linalg.svd(samples.A, full_matrices=False)
Sinv = np.zeros(len(S))
Sinv[S > 0] = 1. / S[S > 0]
W_F = VT.T.dot(np.diag(Sinv)).dot(U.T)
S_F = W_F.dot(samples.flux_nonoise)
S_F = S_F.reshape((samples.nx, samples.ny))

samples.imshow(S_F)
plt.savefig(os.path.join(os.getenv('CRR_DIR'),
                         'tex', 'figures',
                         'scattered-unregularized-noiseless.png'), dpi=dpi)
plt.close('all')


# Now do it with a little bit of noise
samples.set_flux(total_flux=1000., noise=1.e-0)
S_F = W_F.dot(samples.flux)
S_F = S_F.reshape((samples.nx, samples.ny))

samples.imshow(S_F)
plt.savefig(os.path.join(os.getenv('CRR_DIR'),
                         'tex', 'figures',
                         'scattered-unregularized-noisy.png'), dpi=dpi)
plt.close('all')


# Plot the correlation matrix
C_F = W_F.dot(W_F.T)
myargs = {'interpolation': 'nearest',
          'origin': 'lower',
          'cmap': cm.Greys,
          'vmin': -1.,
          'vmax': 1}
CC_F = 0. * C_F
for i in np.arange(samples.nx * samples.ny):
    for j in np.arange(samples.nx * samples.ny):
        CC_F[i, j] = C_F[i, j] / np.sqrt(C_F[i, i] * C_F[j, j])
plt.imshow(CC_F, **myargs)
nmid = (samples.nx * samples.ny) // 2
plt.xlim([nmid - 30, nmid + 30])
plt.ylim([nmid - 30, nmid + 30])
plt.colorbar()
plt.xlabel('pixel $i$')
plt.ylabel('pixel $j$')
plt.savefig(os.path.join(os.getenv('CRR_DIR'),
                         'tex', 'figures',
                         'scattered-unregularized-covar.png'), dpi=dpi)
plt.close('all')
